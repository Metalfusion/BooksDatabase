# kirja.fi "Avainsanat" (Keywords) Investigation Report

## Summary
The "avainsanat" (keywords), "kirjastoluokka" (library classification), and "aiheet" (topics) data is **embedded directly in the server-rendered HTML** by Shopify and is **NOT** available via any API endpoint. This data comes from Shopify product metafields that are not exposed to the Storefront API.

## Findings

### 1. Data Location
The keywords are embedded in the product page HTML within the "Lisätiedot" (Additional Information) accordion section:

```html
<div class="flex gap-base">
  <dt class="flex-shrink-0 w-[10rem] text-sm text-color-muted">
    Avainsanat
  </dt>
  <dd>
    ravekulttuuri • tekno • tanssi • kohtaaminen • yö • Berliini
  </dd>
</div>
```

### 2. Data Source
- **Source**: Shopify Product Metafields
- **Rendering**: Server-side (HTML is generated by Shopify before sending to browser)
- **No separate API**: The data is NOT fetched via JavaScript/AJAX after page load

### 3. Example Product
**URL**: https://kirja.fi/collections/klaus-maunuksela/products/prosessi-9789523522725

**Keywords found**: ravekulttuuri • tekno • tanssi • kohtaaminen • yö • Berliini

### 4. Other Data in "Lisätiedot" Section
The accordion also contains:
- **Kustantaja** (Publisher): Kosmos
- **EAN**: 9789523522725
- **Julkaisu** (Publication date): 25.4.2024
- **Sidosasu** (Binding): Pehmeäkantinen
- **Sivumäärä** (Pages): 294 s.
- **Mitat** (Dimensions): 131 mm × 189 mm × 19 mm
- **Paino** (Weight): 302 g
- **Aiheet** (Topics): Kaunokirjallisuus: yleinen, Moderni kirjallisuus ja nykykirjallisuus
- **Kirjastoluokka** (Library classification): 84.2 - Suomenkielinen kertomakirjallisuus
- **Avainsanat** (Keywords): ravekulttuuri • tekno • tanssi • kohtaaminen • yö • Berliini

## Recommendations for the Scraper

### HTML Parsing is Required (ONLY Option)

Since neither the REST JSON endpoint nor the GraphQL API expose the metafields, you **must** parse the HTML to extract:
- **Avainsanat** (Keywords)
- **Kirjastoluokka** (Library classification)
- **Aiheet** (Topics/Subjects)
- And other metadata fields

All of these fields are in the "Lisätiedot" (Additional Information) accordion section as `<dt>` / `<dd>` pairs.

### Why Other Methods Don't Work

**REST JSON Endpoint** (`/products/{handle}.json`):
- ❌ Does NOT include metafields
- Only includes: basic product info, variants, images, tags

**GraphQL Storefront API** (`/api/unstable/graphql.json`):
- ❌ Metafields return `null` - not exposed to Storefront API
- Tested multiple namespace/key combinations - all failed
- The store owner hasn't configured metafields to be accessible via API

**Conclusion**: HTML parsing is the **ONLY** way to access this data.

### Example Code Structure
```python
import requests
from bs4 import BeautifulSoup

product_url = "https://kirja.fi/products/prosessi-9789523522725"

# Get the HTML page (this is the ONLY way to get metafields)
response = requests.get(product_url)
if response.ok:
    soup = BeautifulSoup(response.text, 'html.parser')
    
    # Find the "Lisätiedot" (Additional Information) section
    # The data is in <details> element with <dt>/<dd> pairs
    
    # Method 1: Find all dt/dd pairs
    metadata = {}
    for dt in soup.find_all('dt'):
        dd = dt.find_next_sibling('dd')
        if dd:
            key = dt.get_text(strip=True)
            value = dd.get_text(strip=True)
            metadata[key] = value
    
    # Now you have all the metafields:
    avainsanat = metadata.get('Avainsanat')  # 'ravekulttuuri • tekno • tanssi • kohtaaminen • yö • Berliini'
    kirjastoluokka = metadata.get('Kirjastoluokka')  # '84.2 - Suomenkielinen kertomakirjallisuus'
    aiheet = metadata.get('Aiheet')  # 'Kaunokirjallisuus: yleinen, Moderni kirjallisuus ja nykykirjallisuus'
    
    # Other available fields:
    # metadata['Kustantaja'] = 'Kosmos'
    # metadata['EAN'] = '9789523522725'
    # metadata['Julkaisu'] = '25.4.2024'
    # metadata['Sidosasu'] = 'Pehmeäkantinen'
    # metadata['Sivumäärä'] = '294 s.'
    # metadata['Mitat'] = '131 mm × 189 mm × 19 mm'
    # metadata['Paino'] = '302 g'
```

## Network Analysis

### API Endpoints Tested:

1. **REST JSON Endpoint**: `GET /products/{handle}.json`
   - Status: 200 ✓
   - Contains: Basic product data (title, price, SKU, images, tags, variants)
   - Metafields: ❌ NOT included

2. **GraphQL Storefront API**: `POST /api/unstable/graphql.json`
   - Status: 200 ✓
   - Tested namespaces: `custom`, `book`, `product`, `global`
   - Tested keys: `avainsanat`, `keywords`, `kirjastoluokka`, `aiheet`
   - Metafields: ❌ All return `null` - not exposed to Storefront API

3. **Initial Page Load**: `GET /collections/klaus-maunuksela/products/prosessi-9789523522725`
   - Status: 200 ✓
   - Content-Type: text/html
   - All product data including metafields: ✓ Embedded in HTML

### Key Requests Observed:
1. **Initial Page Load**: Contains all the data in server-rendered HTML
2. **GraphQL API**: Used for cookie consent, NOT for product metafields
3. **No Separate API for Metafields**: The metafields are only in the HTML

## Conclusion

The scraper **must** parse the HTML to extract the keywords (avainsanat) and other metafield data. The `.json` endpoint does not include this information.

**Recommended approach:**
1. Request the product HTML page
2. Parse the "Lisätiedot" (Additional Information) accordion section
3. Extract all `<dt>` and `<dd>` pairs from the details section
4. Store the following additional fields:
   - **Avainsanat** (Keywords) - e.g., "ravekulttuuri • tekno • tanssi • kohtaaminen • yö • Berliini"
   - **Kustantaja** (Publisher)
   - **Julkaisu** (Publication date)
   - **Sidosasu** (Binding type)
   - **Sivumäärä** (Page count)
   - **Mitat** (Dimensions)
   - **Paino** (Weight)
   - **Aiheet** (Topics/Subjects)
   - **Kirjastoluokka** (Library classification)

**Important Notes:**
- The data is in a `<details>` element that may be collapsed by default
- You don't need to click/expand it - the HTML content is there even when collapsed
- Use proper HTML parsing (BeautifulSoup, lxml, etc.) rather than regex
- The separator for keywords is the bullet character: ` • ` (not a simple dot)

**Date**: January 14, 2026
**Browser Used**: Chrome 143
**Tools Used**: Chrome DevTools, Network Analysis
